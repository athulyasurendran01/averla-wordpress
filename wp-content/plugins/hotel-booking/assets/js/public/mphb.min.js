!function(e){e(function(){MPHB.DateRules=can.Construct.extend({},{dates:{},init:function(e){this.dates=e},canCheckIn:function(e){var t=this.formatDate(e);return!this.dates.hasOwnProperty(t)||!this.dates[t].not_check_in&&!this.dates[t].not_stay_in},canCheckOut:function(e){var t=this.formatDate(e);return!this.dates.hasOwnProperty(t)||!this.dates[t].not_check_out},canStayIn:function(e){var t=this.formatDate(e);return!this.dates.hasOwnProperty(t)||!this.dates[t].not_stay_in},getNearestNotStayInDate:function(t,a){var i=MPHB.Utils.cloneDate(a),n=e.datepick.formatDate("yyyy-mm-dd",t),s=e.datepick.formatDate("yyyy-mm-dd",a);return e.each(this.dates,function(t,a){return!(t>s)&&(n>t||(a.not_stay_in?(i=e.datepick.parseDate("yyyy-mm-dd",t),!1):void 0))}),i},formatDate:function(t){return e.datepick.formatDate("yyyy-mm-dd",t)}}),MPHB.Datepicker=can.Control.extend({},{form:null,hiddenElement:null,init:function(e,t){this.form=t.form,this.setupHiddenElement(),this.initDatepick()},setupHiddenElement:function(){var t=this.element.attr("id")+"-hidden";if(this.hiddenElement=e("#"+t),this.hiddenElement.val()){var a=e.datepick.parseDate(MPHB._data.settings.dateTransferFormat,this.hiddenElement.val()),i=e.datepick.formatDate(MPHB._data.settings.dateFormat,a);this.element.val(i)}else;},initDatepick:function(){var t={dateFormat:MPHB._data.settings.dateFormat,altFormat:MPHB._data.settings.dateTransferFormat,altField:this.hiddenElement,minDate:MPHB.HotelDataManager.myThis.today,monthsToShow:MPHB._data.settings.numberOfMonthDatepicker,firstDay:MPHB._data.settings.firstDay},a=e.extend(t,this.getDatepickSettings());this.element.datepick(a)},getDatepickSettings:function(){return{}},getDate:function(){var t=this.element.val(),a=null;try{a=e.datepick.parseDate(MPHB._data.settings.dateFormat,t)}catch(e){a=null}return a},getFormattedDate:function(t){"undefined"==typeof t&&(t=MPHB._data.settings.dateFormat);var a=this.getDate();return a?e.datepick.formatDate(t,a):""},setDate:function(e){this.element.datepick("setDate",e)},getOption:function(e){return this.element.datepick("option",e)},setOption:function(e,t){this.element.datepick("option",e,t)},getMinDate:function(){var e=this.getOption("minDate");return null!==e&&""!==e?MPHB.Utils.cloneDate(e):null},getMaxDate:function(){var e=this.getOption("maxDate");return null!==e&&""!==e?MPHB.Utils.cloneDate(e):null},clear:function(){this.element.datepick("clear")},formatDate:function(t,a){return a="undefined"!=typeof a?a:"yyyy-mm-dd",e.datepick.formatDate(a,t)},refresh:function(){e.datepick._update(this.element[0],!0),e.datepick._updateInput(this.element[0],!1)}}),MPHB.GlobalRules=can.Construct.extend({},{minDays:null,maxDays:null,checkInDays:null,checkOutDays:null,init:function(e){this.minDays=e.min_days,this.maxDays=e.max_days,this.checkInDays=e.check_in_days,this.checkOutDays=e.check_out_days},isCheckOutSatisfy:function(t){var a=t.getDay().toString();return e.inArray(a,this.checkOutDays)!==-1},isCheckInSatisfy:function(t){var a=t.getDay().toString();return e.inArray(a,this.checkInDays)!==-1},isCorrect:function(t,a){if("undefined"==typeof t||"undefined"==typeof a)return!0;if(!this.isCheckInSatisfy(t))return!1;if(!this.isCheckOutSatisfy(a))return!1;var i=e.datepick.add(MPHB.Utils.cloneDate(t),this.minDays),n=e.datepick.add(MPHB.Utils.cloneDate(t),this.maxDays);return a>=i&&a<=n},getMinCheckOutDate:function(t){return e.datepick.add(MPHB.Utils.cloneDate(t),this.minDays,"d")},getMaxCheckOutDate:function(t){return e.datepick.add(MPHB.Utils.cloneDate(t),this.maxDays,"d")}}),MPHB.HotelDataManager=can.Construct.extend({myThis:null,ROOM_STATUS_AVAILABLE:"available",ROOM_STATUS_NOT_AVAILABLE:"not-available",ROOM_STATUS_BOOKED:"booked",ROOM_STATUS_PAST:"past"},{today:null,roomTypesData:{},globalRules:null,dateRules:null,init:function(t){MPHB.HotelDataManager.myThis=this,this.initRoomTypesData(t.room_types_data),this.initRules(t.rules),this.setToday(e.datepick.parseDate(MPHB._data.settings.dateTransferFormat,t.today))},initRoomTypesData:function(t){var a=this;e.each(t,function(e,t){a.roomTypesData[e]=new MPHB.RoomTypeData(e,t)})},initRules:function(e){this.globalRules=new MPHB.GlobalRules(e.global),this.dateRules=new MPHB.DateRules(e.dates)},setToday:function(e){this.today=e},getRoomTypeData:function(e){return!!this.roomTypesData.hasOwnProperty(e)&&this.roomTypesData[e]},fillDateCellData:function(e,t){var a=[],i=[];return this.dateRules.canStayIn(t)||(a.push(MPHB._data.translations.notStayIn),i.push("mphb-not-stay-in-date")),this.dateRules.canCheckIn(t)&&this.globalRules.isCheckInSatisfy(t)||(a.push(MPHB._data.translations.notCheckIn),i.push("mphb-not-check-in-date")),this.dateRules.canCheckOut(t)&&this.globalRules.isCheckOutSatisfy(t)||(a.push(MPHB._data.translations.notCheckOut),i.push("mphb-not-check-out-date")),a.length&&(e.title+=" "+MPHB._data.translations.rules+" "+a.join(", ")),i.length&&(e.dateClass+=(e.dateClass.length?" ":"")+i.join(" ")),e}}),MPHB.Utils=can.Construct.extend({formatDateToCompare:function(t){return e.datepick.formatDate("yyyymmdd",t)},cloneDate:function(e){return new Date(e.getTime())}},{}),MPHB.Gateway=can.Construct.extend({},{amount:0,paymentDescription:"",init:function(e){this.billingSection=e.billingSection,this.initSettings(e.settings)},initSettings:function(e){this.amount=e.amount,this.paymentDescription=e.paymentDescription},canSubmit:function(){return!0},updateData:function(e){this.amount=e.amount,this.paymentDescription=e.paymentDescription}}),MPHB.StripeGateway=MPHB.Gateway.extend({},{publicKey:"",imageUrl:"",locale:"",allowRememberMe:!1,needBillingAddress:!1,useBitcoin:!1,panelLabel:"",handler:null,init:function(e){this._super(e),this.initHandler()},initSettings:function(e){this._super(e),this.publicKey=e.publicKey,this.imageUrl=e.checkoutImageUrl,this.allowRememberMe=e.allowRememberMe,this.needBillingAddress=e.needBillingAddress,this.useBitcoin=e.useBitcoin,this.locale=e.locale},initHandler:function(){var e=this,t={key:this.publicKey,image:this.imageUrl,locale:this.locale,name:MPHB._data.settings.siteName,bitcoin:this.useBitcoin,currency:MPHB._data.settings.currency.toLowerCase(),billingAddress:this.needBillingAddress,allowRememberMe:this.allowRememberMe};e.panelLabel&&(t.panelLabel=e.panelLabel),this.handler=StripeCheckout.configure(t),window.addEventListener("popstate",function(){e.handler.close()})},openModal:function(){var e=this;this.handler.open({amount:e.amount,description:e.paymentDescription,token:function(t,a){e.storeToken(t),e.needBillingAddress&&e.storeBillingData(a),e.storeEmail(t.email),e.billingSection.parentForm.element.submit(),e.billingSection.showPreloader()}})},canSubmit:function(){if(this.isTokenStored())return!0;try{this.openModal()}catch(e){console.log("error:",e)}return!1},storeToken:function(e){var t=this.billingSection.billingFieldsWrapperEl.find('[name="mphb_stripe_token"]');t.val(e.id)},isTokenStored:function(){var e=this.billingSection.billingFieldsWrapperEl.find('[name="mphb_stripe_token"]');return e.length&&""!==e.val()},storeEmail:function(e){this.billingSection.billingFieldsWrapperEl.find('[name="mphb_stripe_email"]').val(e)},storeBillingData:function(t){var a=this,i=["billing_address_city","billing_address_country","billing_address_country_code","billing_address_line1","billing_address_line2","billing_address_state","billing_address_zip","billing_name"];e.each(i,function(e,i){if(t.hasOwnProperty(i)){var n=a.billingSection.billingFieldsWrapperEl.find('[name="mphb_stripe_'+i+'"]');n.length&&n.val(t[i])}})}}),MPHB.BillingSection=can.Control.extend({},{updateBillingFieldsTimeout:null,parentForm:null,billingFieldsWrapperEl:null,gateways:{},init:function(e,t){this.parentForm=t.form,this.billingFieldsWrapperEl=this.element.find(".mphb-billing-fields"),this.initGateways(t.gateways)},initGateways:function(t){var a=this;e.each(t,function(e,t){var i=null;switch(e){case"stripe":i=new MPHB.StripeGateway({billingSection:a,settings:MPHB._data.gateways[e]});break;default:i=new MPHB.Gateway({billingSection:a,settings:MPHB._data.gateways[e]})}"undefined"!=typeof i&&(a.gateways[e]=i)})},'[name="mphb_gateway_id"] change':function(t,a){var i=this,n=t.val();this.showPreloader(),this.billingFieldsWrapperEl.empty().addClass("mphb-billing-fields-hidden"),clearTimeout(this.updateBillingFieldsTimeout),this.updateBillingFieldsTimeout=setTimeout(function(){var t=i.parentForm.parseFormToJSON();e.ajax({url:MPHB._data.ajaxUrl,type:"GET",dataType:"json",data:{action:"mphb_get_billing_fields",mphb_nonce:MPHB._data.nonces.mphb_get_billing_fields,mphb_gateway_id:n,formValues:t},success:function(e){e.hasOwnProperty("success")?e.success?(i.billingFieldsWrapperEl.html(e.data.fields),e.data.hasVisibleFields?i.billingFieldsWrapperEl.removeClass("mphb-billing-fields-hidden"):i.billingFieldsWrapperEl.addClass("mphb-billing-fields-hidden")):i.showError(e.data.message):i.showError(MPHB._data.translations.errorHasOccured)},error:function(e){i.showError(MPHB._data.translations.errorHasOccured)},complete:function(e){i.hidePreloader()}})},500)},hideErrors:function(){this.parentForm.hideErrors()},showError:function(e){this.parentForm.showError(e)},showPreloader:function(){this.parentForm.showPreloader()},hidePreloader:function(){this.parentForm.hidePreloader()},canSubmit:function(){var e=this.getSelectedGateway();return!this.gateways.hasOwnProperty(e)||this.gateways[e].canSubmit()},getSelectedGateway:function(){return this.element.find('[name="mphb_gateway_id"]:checked').val()},updateGatewaysData:function(t){var a=this;e.each(t,function(e,t){a.gateways.hasOwnProperty(e)&&a.gateways[e].updateData(t)})}}),MPHB.CheckoutForm=can.Control.extend({myThis:null},{priceBreakdownTableEl:null,bookBtnEl:null,errorsWrapperEl:null,preloaderEl:null,billingSection:null,waitResponse:!1,updateInfoTimeout:null,init:function(e,t){MPHB.CheckoutForm.myThis=this,this.bookBtnEl=this.element.find("input[type=submit]"),this.errorsWrapperEl=this.element.find(".mphb-errors-wrapper"),this.preloaderEl=this.element.find(".mphb-preloader"),this.priceBreakdownTableEl=this.element.find("table.mphb-price-breakdown"),MPHB._data.settings.useBilling&&(this.billingSection=new MPHB.BillingSection(this.element.find("#mphb-billing-details"),{form:this,gateways:MPHB._data.gateways}))},setTotal:function(e){var t=this.element.find(".mphb-total-price-field");t.length&&t.html(e)},setDeposit:function(e){var t=this.element.find(".mphb-deposit-amount-field");t.length&&t.html(e)},setupPriceBreakdown:function(e){this.priceBreakdownTableEl.replaceWith(e),this.priceBreakdownTableEl=this.element.find("table.mphb-price-breakdown")},updateCheckoutInfo:function(){var t=this;t.hideErrors(),t.showPreloader(),clearTimeout(this.updateInfoTimeout),this.updateInfoTimeout=setTimeout(function(){var a=t.parseFormToJSON();e.ajax({url:MPHB._data.ajaxUrl,type:"GET",dataType:"json",data:{action:"mphb_update_checkout_info",mphb_nonce:MPHB._data.nonces.mphb_update_checkout_info,formValues:a},success:function(e){e.hasOwnProperty("success")?e.success?(t.setTotal(e.data.total),t.setupPriceBreakdown(e.data.priceBreakdown),MPHB._data.settings.useBilling&&(t.setDeposit(e.data.deposit),t.billingSection.updateGatewaysData(e.data.gateways))):t.showError(e.data.message):t.showError(MPHB._data.translations.errorHasOccured)},error:function(e){t.showError(MPHB._data.translations.errorHasOccured)},complete:function(e){t.hidePreloader()}})},500)},'[name="mphb_room_rate_id"] change':function(e,t){this.updateCheckoutInfo()},".mphb_sc_checkout-services-list input, .mphb_sc_checkout-services-list select change":function(e,t){this.updateCheckoutInfo()},hideErrors:function(){this.errorsWrapperEl.empty().addClass("mphb-hide")},showError:function(e){this.errorsWrapperEl.html(e).removeClass("mphb-hide")},showPreloader:function(){this.waitResponse=!0,this.bookBtnEl.attr("disabled","disabled"),this.preloaderEl.removeClass("mphb-hide")},hidePreloader:function(){this.waitResponse=!1,this.bookBtnEl.removeAttr("disabled"),this.preloaderEl.addClass("mphb-hide")},parseFormToJSON:function(){return this.element.serializeJSON()},submit:function(e,t){return!this.waitResponse&&(!(MPHB._data.settings.useBilling&&!this.billingSection.canSubmit())&&void 0)}}),MPHB.ReservationForm=can.Control.extend({MODE_SUBMIT:"submit",MODE_NORMAL:"normal",MODE_WAITING:"waiting"},{formEl:null,checkInDatepicker:null,checkOutDatepicker:null,reserveBtn:null,reserveBtnPreloader:null,errorsWrapper:null,mode:null,roomTypeId:null,roomTypeData:null,setup:function(e,t){this._super(e,t),this.mode=MPHB.ReservationForm.MODE_NORMAL},init:function(t,a){this.formEl=t,this.roomTypeId=parseInt(this.formEl.attr("id").replace(/^booking-form-/,"")),this.roomTypeData=MPHB.HotelDataManager.myThis.getRoomTypeData(this.roomTypeId),this.errorsWrapper=this.formEl.find(".mphb-errors-wrapper"),this.initCheckInDatepicker(),this.initCheckOutDatepicker(),this.initReserveBtn();var i=this;e(window).on("mphb-update-date-room-type-"+this.roomTypeId,function(){i.reservationForm.refreshDatepickers()})},submit:function(t,a){if(this.mode!==MPHB.ReservationForm.MODE_SUBMIT){a.preventDefault(),a.stopPropagation(),this.setFormWaitingMode();var i=this;e.ajax({url:MPHB._data.ajaxUrl,type:"GET",dataType:"json",data:{action:"mphb_check_room_availability",mphb_nonce:MPHB._data.nonces.mphb_check_room_availability,roomTypeId:i.roomTypeId,checkInDate:this.checkInDatepicker.getFormattedDate(MPHB._data.settings.dateTransferFormat),checkOutDate:this.checkOutDatepicker.getFormattedDate(MPHB._data.settings.dateTransferFormat)},success:function(e){e.hasOwnProperty("success")?e.success?i.proceedToCheckout():(i.showError(e.data.message),e.data.hasOwnProperty("updatedData")&&i.roomTypeData.update(e.data.updatedData),i.clearDatepickers()):i.showError(MPHB._data.translations.errorHasOccured)},error:function(e){i.showError(MPHB._data.translations.errorHasOccured)},complete:function(e){i.setFormNormalMode()}})}},proceedToCheckout:function(){this.mode=MPHB.ReservationForm.MODE_SUBMIT,this.unlock(),this.formEl.submit()},showError:function(t){this.clearErrors();var a=e("<p>",{class:"mphb-error",html:t});this.errorsWrapper.append(a).removeClass("mphb-hide")},clearErrors:function(){this.errorsWrapper.empty().addClass("mphb-hide")},lock:function(){this.element.find("[name]").attr("disabled","disabled"),this.reserveBtn.attr("disabled","disabled").addClass("mphb-disabled"),this.reserveBtnPreloader.removeClass("mphb-hide")},unlock:function(){this.element.find("[name]").removeAttr("disabled"),this.reserveBtn.removeAttr("disabled","disabled").removeClass("mphb-disabled"),this.reserveBtnPreloader.addClass("mphb-hide")},setFormWaitingMode:function(){this.mode=MPHB.ReservationForm.MODE_WAITING,this.lock()},setFormNormalMode:function(){this.mode=MPHB.ReservationForm.MODE_NORMAL,this.unlock()},initCheckInDatepicker:function(){var e=this.formEl.find('input[type="text"][name=mphb_check_in_date]');this.checkInDatepicker=new MPHB.RoomTypeCheckInDatepicker(e,{form:this})},initCheckOutDatepicker:function(){var e=this.formEl.find('input[type="text"][name=mphb_check_out_date]');this.checkOutDatepicker=new MPHB.RoomTypeCheckOutDatepicker(e,{form:this})},initReserveBtn:function(){this.reserveBtn=this.formEl.find(".mphb-reserve-btn"),this.reserveBtnPreloader=this.formEl.find(".mphb-preloader"),this.setFormNormalMode()},updateCheckOutLimitations:function(e){"undefined"==typeof e&&(e=!0);var t=this.retrieveCheckOutLimitations(this.checkInDatepicker.getDate(),this.checkOutDatepicker.getDate());this.checkOutDatepicker.setOption("minDate",t.minDate),this.checkOutDatepicker.setOption("maxDate",t.maxDate),this.checkOutDatepicker.setDate(e?t.date:null)},retrieveCheckOutLimitations:function(e,t){var a=MPHB.HotelDataManager.myThis.today,i=null,n=null;if(null!==e){var a=MPHB.HotelDataManager.myThis.globalRules.getMinCheckOutDate(e),i=MPHB.HotelDataManager.myThis.globalRules.getMaxCheckOutDate(e);i=this.roomTypeData.getNearestLockedDate(e,i),i=this.roomTypeData.getNearestHaveNotPriceDate(e,i),i=MPHB.HotelDataManager.myThis.dateRules.getNearestNotStayInDate(e,i),n=this.isCheckOutDateNotValid(t,a,i)?this.retrieveRecommendedCheckOutDate(a,i):t}return{minDate:a,maxDate:i,date:n}},retrieveRecommendedCheckOutDate:function(t,a){for(var i=null,n=MPHB.Utils.cloneDate(t);MPHB.Utils.formatDateToCompare(n)<=MPHB.Utils.formatDateToCompare(a);){var s=e.datepick.add(MPHB.Utils.cloneDate(n),-1,"d");if(!this.isCheckOutDateNotValid(n,t,a)&&this.roomTypeData.hasPriceForDate(s)){i=n;break}n=e.datepick.add(n,1,"d")}return i},isCheckOutDateNotValid:function(e,t,a){return null===e||MPHB.Utils.formatDateToCompare(e)<MPHB.Utils.formatDateToCompare(t)||MPHB.Utils.formatDateToCompare(e)>MPHB.Utils.formatDateToCompare(a)||!MPHB.HotelDataManager.myThis.globalRules.isCheckOutSatisfy(e)||!MPHB.HotelDataManager.myThis.dateRules.canCheckOut(e)},clearDatepickers:function(){this.checkInDatepicker.clear(),this.checkOutDatepicker.clear()},refreshDatepickers:function(){this.checkInDatepicker.refresh(),this.checkOutDatepicker.refresh()}}),MPHB.RoomTypeCalendar=can.Control.extend({},{roomTypeData:null,roomTypeId:null,init:function(t,a){this.roomTypeId=parseInt(t.attr("id").replace(/^mphb-calendar-/,"")),this.roomTypeData=MPHB.HotelDataManager.myThis.getRoomTypeData(this.roomTypeId);var i=this;t.hide().datepick({onDate:function(e,t){var a={selectable:!1,dateClass:"mphb-date-cell",title:""};return t?a=i.roomTypeData.fillDateData(a,e):a.dateClass+=" mphb-extra-date",a},minDate:MPHB.HotelDataManager.myThis.today,monthsToShow:MPHB._data.settings.numberOfMonthCalendar,firstDay:MPHB._data.settings.firstDay}).show(),e(window).on("mphb-update-room-type-data-"+this.roomTypeId,function(e){i.refresh()})},refresh:function(){this.element.hide(),e.datepick._update(this.element[0],!0),this.element.show()}}),MPHB.RoomTypeCheckInDatepicker=MPHB.Datepicker.extend({},{getDatepickSettings:function(){var e=this;return{onDate:function(t,a){var i={dateClass:"mphb-date-cell",selectable:!1,title:""};if(a){var n=e.form.roomTypeData.getDateStatus(t);i=e.form.roomTypeData.fillDateData(i,t);var s=n===MPHB.HotelDataManager.ROOM_STATUS_AVAILABLE&&MPHB.HotelDataManager.myThis.globalRules.isCheckInSatisfy(t)&&MPHB.HotelDataManager.myThis.dateRules.canCheckIn(t);s&&(i.selectable=!0)}else i.dateClass+=" mphb-extra-date";return i.selectable&&(i.dateClass+=" mphb-date-selectable"),i},onSelect:function(t){e.form.updateCheckOutLimitations()},pickerClass:"mphb-datepick-popup mphb-check-in-datepick"}},setDate:function(e){return null==e?this._super(e):MPHB.HotelDataManager.myThis.globalRules.isCheckInSatisfy(e)&&MPHB.HotelDataManager.myThis.dateRules.canCheckIn(e)?this._super(e):this._super(null)}}),MPHB.RoomTypeCheckOutDatepicker=MPHB.Datepicker.extend({},{getDatepickSettings:function(){var e=this;return{onDate:function(t,a){var i={dateClass:"mphb-date-cell",selectable:!1,title:""};if(a){var n=e.form.checkInDatepicker.getDate(),s=null!==e.getMinDate()&&MPHB.Utils.formatDateToCompare(t)<MPHB.Utils.formatDateToCompare(e.getMinDate()),r=null!==e.getMaxDate()&&MPHB.Utils.formatDateToCompare(t)>MPHB.Utils.formatDateToCompare(e.getMaxDate());if(null!==n&&MPHB.Utils.formatDateToCompare(t)===MPHB.Utils.formatDateToCompare(n)&&(i.dateClass+=" mphb-check-in-date",i.title+=MPHB._data.translations.checkInDate),s){var o=MPHB.HotelDataManager.myThis.globalRules.getMinCheckOutDate(n);MPHB.Utils.formatDateToCompare(t)<MPHB.Utils.formatDateToCompare(n)?i.dateClass+=" mphb-earlier-min-date mphb-earlier-check-in-date":MPHB.Utils.formatDateToCompare(t)<MPHB.Utils.formatDateToCompare(o)&&(i.dateClass+=" mphb-earlier-min-date",i.title+=(i.title.length?" ":"")+MPHB._data.translations.lessThanMinDaysStay)}if(r){var l=MPHB.HotelDataManager.myThis.globalRules.getMaxCheckOutDate(n);MPHB.Utils.formatDateToCompare(t)<MPHB.Utils.formatDateToCompare(l)?i.title+=(i.title.length?" ":"")+MPHB._data.translations.laterThanMaxDate:i.title+=(i.title.length?" ":"")+MPHB._data.translations.moreThanMaxDaysStay,i.dateClass+=" mphb-later-max-date"}i=e.form.roomTypeData.fillDateData(i,t);var c=!s&&!r&&MPHB.HotelDataManager.myThis.globalRules.isCheckOutSatisfy(t)&&MPHB.HotelDataManager.myThis.dateRules.canCheckOut(t);c&&(i.selectable=!0)}else i.dateClass+=" mphb-extra-date";return i.selectable?i.dateClass+=" mphb-selectable-date":i.dateClass+=" mphb-unselectable-date",i},pickerClass:"mphb-datepick-popup mphb-check-out-datepick"}},setDate:function(e){return null==e?this._super(e):MPHB.HotelDataManager.myThis.globalRules.isCheckOutSatisfy(e)&&MPHB.HotelDataManager.myThis.dateRules.canCheckOut(e)?this._super(e):this._super(null)}}),MPHB.RoomTypeData=can.Construct.extend({},{id:null,bookedDates:{},havePriceDates:{},activeRoomsCount:0,init:function(e,t){this.id=e,this.setRoomsCount(t.activeRoomsCount),this.setDates(t.dates)},update:function(t){t.hasOwnProperty("activeRoomsCount")&&this.setRoomsCount(t.activeRoomsCount),t.hasOwnProperty("dates")&&this.setDates(t.dates),e(window).trigger("mphb-update-room-type-data-"+this.id)},setRoomsCount:function(e){this.activeRoomsCount=e},setDates:function(e){this.bookedDates=e.hasOwnProperty("booked")?e.booked:{},this.havePriceDates=e.hasOwnProperty("havePrice")?e.havePrice:{}},getNearestLockedDate:function(t,a){var i=a,n=this,s=e.datepick.formatDate("yyyy-mm-dd",t),r=e.datepick.formatDate("yyyy-mm-dd",a);return e.each(n.getLockedDates(),function(t,a){return!(r<t)&&(s>t||(a>=n.activeRoomsCount?(i=e.datepick.parseDate("yyyy-mm-dd",t),!1):void 0))}),i},getNearestHaveNotPriceDate:function(t,a){for(var i=MPHB.Utils.cloneDate(a),n=MPHB.Utils.cloneDate(t);MPHB.Utils.formatDateToCompare(n)<=MPHB.Utils.formatDateToCompare(a);){if(!this.hasPriceForDate(n)){i=n;break}n=e.datepick.add(n,1,"d")}return i},getLockedDates:function(){var t={};return e.extend(t,this.bookedDates)},getHavePriceDates:function(){var t={};return e.extend(t,this.havePriceDates)},getDateStatus:function(e){var t=MPHB.HotelDataManager.ROOM_STATUS_AVAILABLE;return this.isEarlierThanToday(e)?t=MPHB.HotelDataManager.ROOM_STATUS_PAST:this.isDateBooked(e)?t=MPHB.HotelDataManager.ROOM_STATUS_BOOKED:this.hasPriceForDate(e)||(t=MPHB.HotelDataManager.ROOM_STATUS_NOT_AVAILABLE),t},isDateBooked:function(t){var a=e.datepick.formatDate("yyyy-mm-dd",t);return this.bookedDates.hasOwnProperty(a)&&this.bookedDates[a]>=this.activeRoomsCount},hasPriceForDate:function(t){var a=e.datepick.formatDate("yyyy-mm-dd",t);return e.inArray(a,this.havePriceDates)!==-1},getAvailableRoomsCount:function(t){var a=e.datepick.formatDate("yyyy-mm-dd",t),i=this.bookedDates.hasOwnProperty(a)?this.activeRoomsCount-this.bookedDates[a]:this.activeRoomsCount;return i<0&&(i=0),i},fillDateData:function(e,t){var a=this.getDateStatus(t),i=[],n=[];switch(a){case MPHB.HotelDataManager.ROOM_STATUS_PAST:n.push("mphb-past-date"),i.push(MPHB._data.translations.past);break;case MPHB.HotelDataManager.ROOM_STATUS_AVAILABLE:n.push("mphb-available-date"),i.push(MPHB._data.translations.available+"("+this.getAvailableRoomsCount(t)+")");break;case MPHB.HotelDataManager.ROOM_STATUS_NOT_AVAILABLE:n.push("mphb-not-available-date"),i.push(MPHB._data.translations.notAvailable);break;case MPHB.HotelDataManager.ROOM_STATUS_BOOKED:n.push("mphb-booked-date"),i.push(MPHB._data.translations.booked)}return e.dateClass+=(e.dateClass.length?" ":"")+n.join(" "),e.title+=(e.title.length?", ":"")+i.join(", "),e=MPHB.HotelDataManager.myThis.fillDateCellData(e,t)},appendRulesToTitle:function(e,t){var a=[];return MPHB.HotelDataManager.myThis.dateRules.canStayIn(e)||a.push(MPHB._data.translations.notStayIn),MPHB.HotelDataManager.myThis.dateRules.canCheckIn(e)||a.push(MPHB._data.translations.notCheckIn),MPHB.HotelDataManager.myThis.dateRules.canCheckOut(e)||a.push(MPHB._data.translations.notCheckOut),a.length&&(t+=" "+MPHB._data.translations.rules+" "+a.join(", ")),t},isEarlierThanToday:function(e){return MPHB.Utils.formatDateToCompare(e)<MPHB.Utils.formatDateToCompare(MPHB.HotelDataManager.myThis.today)}}),MPHB.SearchCheckInDatepicker=MPHB.Datepicker.extend({},{getDatepickSettings:function(){var e=this;return{onSelect:function(t){e.form.updateCheckOutLimitations()},onDate:function(e,t){var a={dateClass:"mphb-date-cell",selectable:!1,title:""};if(t){var i=MPHB.HotelDataManager.myThis.globalRules.isCheckInSatisfy(e)&&MPHB.HotelDataManager.myThis.dateRules.canCheckIn(e);i&&(a.selectable=!0),a=MPHB.HotelDataManager.myThis.fillDateCellData(a,e)}else a.dateClass+=" mphb-extra-date";return a.selectable?a.dateClass+=" mphb-selectable-date":a.dateClass+=" mphb-unselectable-date",a},pickerClass:"mphb-datepick-popup mphb-check-in-datepick"}}}),MPHB.SearchCheckOutDatepicker=MPHB.Datepicker.extend({},{getDatepickSettings:function(){var e=this;return{onDate:function(t,a){var i={dateClass:"mphb-date-cell",selectable:!1,title:""};if(a){var n=e.form.checkInDatepicker.getDate(),s=null!==e.getMinDate()&&MPHB.Utils.formatDateToCompare(t)<MPHB.Utils.formatDateToCompare(e.getMinDate()),r=null!==e.getMaxDate()&&MPHB.Utils.formatDateToCompare(t)>MPHB.Utils.formatDateToCompare(e.getMaxDate());if(null!==n&&MPHB.Utils.formatDateToCompare(t)===MPHB.Utils.formatDateToCompare(n)&&(i.dateClass+=" mphb-check-in-date",i.title+=MPHB._data.translations.checkInDate),s&&(MPHB.Utils.formatDateToCompare(t)<MPHB.Utils.formatDateToCompare(n)?i.dateClass+=" mphb-earlier-min-date mphb-earlier-check-in-date":(i.dateClass+=" mphb-earlier-min-date",i.title+=(i.title.length?" ":"")+MPHB._data.translations.lessThanMinDaysStay)),r){var o=MPHB.HotelDataManager.myThis.globalRules.getMaxCheckOutDate(n);MPHB.Utils.formatDateToCompare(t)<MPHB.Utils.formatDateToCompare(o)?i.title+=(i.title.length?" ":"")+MPHB._data.translations.laterThanMaxDate:i.title+=(i.title.length?" ":"")+MPHB._data.translations.moreThanMaxDaysStay,i.dateClass+=" mphb-later-max-date"}i=MPHB.HotelDataManager.myThis.fillDateCellData(i,t);var l=!s&&!r&&MPHB.HotelDataManager.myThis.globalRules.isCheckOutSatisfy(t)&&MPHB.HotelDataManager.myThis.dateRules.canCheckOut(t);l&&(i.selectable=!0)}else i.dateClass+=" mphb-extra-date";return i.selectable?i.dateClass+=" mphb-selectable-date":i.dateClass+=" mphb-unselectable-date",i},pickerClass:"mphb-datepick-popup mphb-check-in-datepick"}}}),MPHB.SearchForm=can.Control.extend({},{checkInDatepickerEl:null,checkOutDatepickerEl:null,checkInDatepicker:null,checkOutDatepicker:null,init:function(e,t){this.checkInDatepickerEl=this.element.find(".mphb-datepick[name=mphb_check_in_date]"),this.checkOutDatepickerEl=this.element.find(".mphb-datepick[name=mphb_check_out_date]"),this.checkInDatepicker=new MPHB.SearchCheckInDatepicker(this.checkInDatepickerEl,{form:this}),this.checkOutDatepicker=new MPHB.SearchCheckOutDatepicker(this.checkOutDatepickerEl,{form:this})},updateCheckOutLimitations:function(e){"undefined"==typeof e&&(e=!0);var t=this.retrieveCheckOutLimitations(this.checkInDatepicker.getDate(),this.checkOutDatepicker.getDate());this.checkOutDatepicker.setOption("minDate",t.minDate),this.checkOutDatepicker.setOption("maxDate",t.maxDate),this.checkOutDatepicker.setDate(e?t.date:null)},retrieveCheckOutLimitations:function(e,t){var a=MPHB.HotelDataManager.myThis.today,i=null,n=null;if(null!==e){var a=MPHB.HotelDataManager.myThis.globalRules.getMinCheckOutDate(e),i=MPHB.HotelDataManager.myThis.globalRules.getMaxCheckOutDate(e);i=MPHB.HotelDataManager.myThis.dateRules.getNearestNotStayInDate(e,i),n=this.isCheckOutDateNotValid(t,a,i)?this.retrieveRecommendedCheckOutDate(a,i):t}return{minDate:a,maxDate:i,date:n}},retrieveRecommendedCheckOutDate:function(t,a){for(var i=null,n=MPHB.Utils.cloneDate(t);MPHB.Utils.formatDateToCompare(n)<=MPHB.Utils.formatDateToCompare(a);){if(!this.isCheckOutDateNotValid(n,t,a)){i=n;break}n=e.datepick.add(n,1,"d")}return i},isCheckOutDateNotValid:function(e,t,a){return null===e||MPHB.Utils.formatDateToCompare(e)<MPHB.Utils.formatDateToCompare(t)||MPHB.Utils.formatDateToCompare(e)>MPHB.Utils.formatDateToCompare(a)||!MPHB.HotelDataManager.myThis.globalRules.isCheckOutSatisfy(e)||!MPHB.HotelDataManager.myThis.dateRules.canCheckOut(e)}}),new MPHB.HotelDataManager(MPHB._data),MPHB._data.page.isCheckoutPage&&new MPHB.CheckoutForm(e(".mphb_sc_checkout-form"));var t=e(".mphb-calendar.mphb-datepick");e.each(t,function(t,a){new MPHB.RoomTypeCalendar(e(a))});var a=e(".mphb-booking-form");e.each(a,function(t,a){new MPHB.ReservationForm(e(a))});var i=e("form.mphb_sc_search-form,form.mphb_widget_search-form");e.each(i,function(t,a){new MPHB.SearchForm(e(a))})})}(jQuery);