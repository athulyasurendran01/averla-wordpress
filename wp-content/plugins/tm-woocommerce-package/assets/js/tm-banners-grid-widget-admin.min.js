!function(a){"use strict";var b={init:function(b,c){function A(){if(r.closest("form").validate({onsubmit:!1}).element(r)){var c=q.find(".tm_banners_grid_widget_banner_id").val(),d=m.val()?m.val().split(/(?=\S),(?=\S)/):[],e=n.val()?n.val().split(/(?=\S),(?=\S)/):[],f=o.val()?o.val().split(/(?=\S),(?=\S)/):[],g=p.val()?p.val().split(/(?=\S),(?=\S)/):[];d[c]=r.val(),e[c]=s.val(),f[c]=t.val(),g[c]=u.val(),m.val(d.join()),n.val(e.join()),o.val(f.join()),p.val(g.join()),m.trigger("change"),q.dialog("close")}}function B(){g=f.find(".tm_banners_grid_widget_img_col"),h=g.find(".banner_remove"),i=g.find(".banner_link"),h.on("click",function(){var b=a(this).closest(".tm_banners_grid_widget_img_col").index(),c=l.val().split(/(?=\S),(?=\S)/),e=m.val()?m.val().split(/(?=\S),(?=\S)/):[],f=n.val()?n.val().split(/(?=\S),(?=\S)/):[],g=o.val()?o.val().split(/(?=\S),(?=\S)/):[],h=p.val()?p.val().split(/(?=\S),(?=\S)/):[];c.splice(b,1),e.splice(b,1),f.splice(b,1),g.splice(b,1),h.splice(b,1),l.val(c.join()),m.val(e.join()),n.val(f.join()),o.val(g.join()),p.val(h.join()),a(this).closest(".tm_banners_grid_widget_img_col").remove(),k.hide().find("input").removeAttr("checked"),0<c.length&&k.eq(c.length-1).show().find("input").eq(0).prop("checked",!0),c.length<bannerGridWidgetAdmin.maxBanners&&d.show(),l.trigger("change")}),i.on("click",function(){var b=a(this).closest(".tm_banners_grid_widget_img_col").index(),c=m.val()?m.val().split(/(?=\S),(?=\S)/):[],d=n.val()?n.val().split(/(?=\S),(?=\S)/):[],e=o.val()?o.val().split(/(?=\S),(?=\S)/):[],f=p.val()?p.val().split(/(?=\S),(?=\S)/):[];a(".tm_banners_grid_widget_banner_id").val(b),q.dialog("open"),r.val(c[b]?c[b]:""),s.find("option").filter(function(){return void 0!==d[b]&&a(this).val()==d[b]}).prop("selected",!0),t.val(e[b]?e[b]:""),u.val(f[b]?f[b]:"")})}function C(a,b,c){return x=a.splice(b,1),y=a.slice(0,c),z=a.slice(c),a=y.concat(x).concat(z),a.join()}var v,w,x,y,z,d=c.find(".tm_banners_grid_widget_add_media"),e=c.find(".tm_banners_grid_widget_banners_thumbs"),f=e.find(".tm_banners_grid_widget_banners_thumbs_inner"),g=f.find(".tm_banners_grid_widget_img_col"),h=g.find(".banner_remove"),i=g.find(".banner_link"),j=c.find(".tm_banners_grid_widget_banners_grids"),k=j.find(".tm_banners_grid_widget_banners_grid"),l=c.find(".tm_banners_grid_widget_banners"),m=c.find(".tm_banners_grid_widget_banners_links"),n=c.find(".tm_banners_grid_widget_banners_links_targets"),o=c.find(".tm_banners_grid_widget_banners_titles"),p=c.find(".tm_banners_grid_widget_banners_texts"),q=c.find(".banner_link_wrapper"),r=c.find(".tm_banners_grid_widget_banner_link"),s=c.find(".tm_banners_grid_widget_banner_link_target"),t=c.find(".tm_banners_grid_widget_banner_title"),u=c.find(".tm_banners_grid_widget_banner_text");a.validator.methods.url=function(a,b){return this.optional(b)||/(\/?[\w-]+)(\/[\w-]+)*\/?|(#)|(((http|ftp|https):\/\/)?[\w-]+(\.[\w-]+)+([\w.,@?^=%&amp;:\/~+#-]*[\w@?^=%&amp;\/~+#-])?)/gi.test(a)},g.length<bannerGridWidgetAdmin.maxBanners&&d.show(),0<g.length&&k.eq(g.length-1).show(),d.on("click",function(a){if(b)return void b.open();var b=wp.media.frames.downloadable_file=wp.media({title:bannerGridWidgetAdmin.mediaFrameTitle,multiple:!0});b.on("select",function(){for(var e,a=[],c=l.val()?l.val().split(/(?=\S),(?=\S)/):[],g=bannerGridWidgetAdmin.maxBanners-c.length,h=b.state().get("selection").toJSON().slice(0,g),i=0;i<h.length;i++)a[i]=h[i].id,f.append(bannerGridWidgetAdmin.col.replace(/%s/g,h[i].sizes.thumbnail.url));e=c.concat(a),6==e.length&&d.hide(),k.hide().find("input").removeAttr("checked"),k.eq(e.length-1).show().find("input").eq(0).prop("checked",!0),b.detach(),B(),l.val(e.join()).trigger("change")}),b.open()}),q.wrapInner("<form/>").dialog({dialogClass:"wp-dialog",modal:!0,autoOpen:!1,closeOnEscape:!0,buttons:{Add:A,Cancel:function(){q.dialog("close")}}}),B(),f.sortable({distance:2,zIndex:100,disabled:!1,start:function(a,b){v=b.item.index()},update:function(a,b){var c=l.val().split(/(?=\S),(?=\S)/),d=m.val()?m.val().split(/(?=\S),(?=\S)/):[],e=n.val()?n.val().split(/(?=\S),(?=\S)/):[],f=o.val()?o.val().split(/(?=\S),(?=\S)/):[],g=p.val()?p.val().split(/(?=\S),(?=\S)/):[];w=b.item.index(),l.val(C(c,v,w)),0<d.length&&(d.length<c.length&&(d[c.length]=""),m.val(C(d,v,w))),0<e.length&&(e.length<c.length&&(e[c.length]=""),n.val(C(e,v,w))),0<f.length&&(f.length<c.length&&(f[c.length]=""),o.val(C(f,v,w))),0<g.length&&(g.length<c.length&&(g[c.length]=""),p.val(C(g,v,w))),l.trigger("change")}})}};a("#widgets-right").find("div.widget[id*=tm_banners_grid_widget]").each(function(){b.init("init",a(this))}),a(document).on("widget-updated widget-added",function(a,c){c.is("[id*=tm_banners_grid_widget]")&&b.init(a,c)})}(jQuery);